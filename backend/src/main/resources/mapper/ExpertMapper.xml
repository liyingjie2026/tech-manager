<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.research.project.mapper.ExpertMapper">
    
    <resultMap id="BaseResultMap" type="com.research.project.entity.Expert">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="expert_code" property="expertCode"/>
        <result column="name" property="name"/>
        <result column="gender" property="gender"/>
        <result column="birth_date" property="birthDate"/>
        <result column="id_card" property="idCard"/>
        <result column="phone" property="phone"/>
        <result column="email" property="email"/>
        <result column="organization" property="organization"/>
        <result column="department" property="department"/>
        <result column="position" property="position"/>
        <result column="title" property="title"/>
        <result column="education" property="education"/>
        <result column="degree" property="degree"/>
        <result column="graduate_school" property="graduateSchool"/>
        <result column="major" property="major"/>
        <result column="research_field" property="researchField"/>
        <result column="expert_type" property="expertType"/>
        <result column="specialty" property="specialty"/>
        <result column="introduction" property="introduction"/>
        <result column="achievements" property="achievements"/>
        <result column="bank_account" property="bankAccount"/>
        <result column="bank_name" property="bankName"/>
        <result column="review_count" property="reviewCount"/>
        <result column="good_rate" property="goodRate"/>
        <result column="available" property="available"/>
        <result column="audit_status" property="auditStatus"/>
        <result column="audit_comment" property="auditComment"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="create_by" property="createBy"/>
        <result column="update_by" property="updateBy"/>
        <result column="deleted" property="deleted"/>
    </resultMap>
    
    <select id="selectByUserId" resultMap="BaseResultMap">
        SELECT * FROM res_expert WHERE user_id = #{userId} AND deleted = 0
    </select>
    
    <select id="selectByResearchField" resultMap="BaseResultMap">
        SELECT * FROM res_expert 
        WHERE research_field LIKE CONCAT('%', #{researchField}, '%') 
        AND available = 1 AND status = 1 AND deleted = 0
    </select>
    
    <select id="selectRandomExperts" resultMap="BaseResultMap">
        SELECT * FROM res_expert 
        WHERE deleted = 0
        <if test="researchField != null and researchField != ''">
            AND (research_field LIKE CONCAT('%', #{researchField}, '%')
                 OR specialty LIKE CONCAT('%', #{researchField}, '%')
                 OR major LIKE CONCAT('%', #{researchField}, '%'))
        </if>
        <if test="excludeIds != null and excludeIds.size() > 0">
            AND id NOT IN
            <foreach collection="excludeIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
        ORDER BY RAND()
        LIMIT #{count}
    </select>
    
    <!-- 分页查询专家列表 - 对应Controller: list() -->
    <select id="selectPageList" resultMap="BaseResultMap">
        SELECT * FROM res_expert
        WHERE deleted = 0
        <if test="keyword != null and keyword != ''">
            AND (name LIKE CONCAT('%', #{keyword}, '%') 
                 OR expert_code LIKE CONCAT('%', #{keyword}, '%')
                 OR phone LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="researchField != null and researchField != ''">
            AND research_field LIKE CONCAT('%', #{researchField}, '%')
        </if>
        <if test="expertType != null and expertType != ''">
            AND expert_type = #{expertType}
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY create_time DESC
    </select>
    
    <!-- 导入专家 - 对应Controller: importExperts() -->
    <insert id="batchInsertExperts">
        INSERT INTO res_expert (
            expert_code, name, gender, phone, email, organization, 
            department, position, title, research_field, expert_type, 
            specialty, available, status, create_time, create_by
        ) VALUES
        <foreach collection="experts" item="expert" separator=",">
            (
                #{expert.expertCode}, #{expert.name}, #{expert.gender}, 
                #{expert.phone}, #{expert.email}, #{expert.organization},
                #{expert.department}, #{expert.position}, #{expert.title},
                #{expert.researchField}, #{expert.expertType}, #{expert.specialty},
                1, 1, NOW(), #{createBy}
            )
        </foreach>
    </insert>
    
    <!-- 启用专家 - 对应Controller: enable() -->
    <update id="enableExpert">
        UPDATE res_expert SET available = 1, update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>
    
    <!-- 禁用专家 - 对应Controller: disable() -->
    <update id="disableExpert">
        UPDATE res_expert SET available = 0, update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>
    
    <!-- 审核专家 - 对应Controller: audit() -->
    <update id="auditExpert">
        UPDATE res_expert SET
            audit_status = #{auditStatus},
            status = #{status},
            audit_comment = #{auditComment},
            update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>
    
    <!-- 更新评审统计 - 对应Controller内部调用 -->
    <update id="updateReviewStats">
        UPDATE res_expert SET
            review_count = review_count + 1,
            good_rate = #{goodRate},
            update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>
    
    <!-- 批量删除 - 对应Controller: batchDelete() -->
    <update id="batchDeleteExperts">
        UPDATE res_expert SET deleted = 1, update_time = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>
    
    <!-- 统计专家数量 -->
    <select id="selectCountByField" resultType="map">
        SELECT research_field, COUNT(*) as count
        FROM res_expert WHERE deleted = 0 AND status = 1
        GROUP BY research_field
    </select>
    
</mapper>
