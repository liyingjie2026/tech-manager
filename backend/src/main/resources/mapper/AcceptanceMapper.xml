<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.research.project.mapper.AcceptanceMapper">
    
    <resultMap id="BaseResultMap" type="com.research.project.entity.Acceptance">
        <id column="id" property="id"/>
        <result column="acceptance_no" property="acceptanceNo"/>
        <result column="project_id" property="projectId"/>
        <result column="project_no" property="projectNo"/>
        <result column="project_name" property="projectName"/>
        <result column="institution_name" property="institutionName"/>
        <result column="project_leader" property="projectLeader"/>
        <result column="start_date" property="startDate"/>
        <result column="end_date" property="endDate"/>
        <result column="total_budget" property="totalBudget"/>
        <result column="used_budget" property="usedBudget"/>
        <result column="completion_desc" property="completionDesc"/>
        <result column="indicator_completion" property="indicatorCompletion"/>
        <result column="achievements" property="achievements"/>
        <result column="budget_usage" property="budgetUsage"/>
        <result column="benefits" property="benefits"/>
        <result column="problems" property="problems"/>
        <result column="attachments" property="attachments"/>
        <result column="acceptance_method" property="acceptanceMethod"/>
        <result column="conclusion" property="conclusion"/>
        <result column="acceptance_comment" property="acceptanceComment"/>
        <result column="acceptance_time" property="acceptanceTime"/>
        <result column="expert_group" property="expertGroup"/>
        <result column="status" property="status"/>
        <result column="audit_comment" property="auditComment"/>
        <result column="audit_time" property="auditTime"/>
        <result column="audit_by" property="auditBy"/>
        <result column="submit_time" property="submitTime"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="create_by" property="createBy"/>
        <result column="update_by" property="updateBy"/>
        <result column="deleted" property="deleted"/>
    </resultMap>
    
    <select id="selectByProjectId" resultMap="BaseResultMap">
        SELECT * FROM prj_acceptance WHERE project_id = #{projectId} AND deleted = 0
    </select>
    
    <!-- 更新验收状态 - 对应Controller: submit(), withdraw() -->
    <update id="updateStatus">
        UPDATE prj_acceptance SET 
            status = #{status},
            update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>
    
    <!-- 更新审核信息 - 对应Controller: approve(), reject(), audit() -->
    <update id="updateAudit">
        UPDATE prj_acceptance SET 
            conclusion = #{conclusion},
            acceptance_comment = #{comment},
            audit_time = NOW(),
            update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>
    
    <!-- 发起专家评审 - 对应Controller: startReview() -->
    <insert id="startExpertReview">
        INSERT INTO prj_expert_review (
            business_type, business_id, expert_id, deadline, status, create_time
        ) VALUES
        <foreach collection="expertIds" item="expertId" separator=",">
            ('acceptance', #{id}, #{expertId}, #{deadline}, 'pending', NOW())
        </foreach>
    </insert>
    
    <!-- 添加附件 - 对应Controller: addAttachments() -->
    <insert id="insertAttachments">
        INSERT INTO prj_acceptance_attachment (
            acceptance_id, file_id, create_time
        ) VALUES
        <foreach collection="fileIds" item="fileId" separator=",">
            (#{id}, #{fileId}, NOW())
        </foreach>
    </insert>
    
    <!-- 获取统计数据 - 对应Controller: getStatistics() -->
    <select id="selectStatistics" resultType="map">
        SELECT 
            COUNT(*) as total,
            SUM(CASE WHEN status = 'draft' THEN 1 ELSE 0 END) as draftCount,
            SUM(CASE WHEN status = 'submitted' THEN 1 ELSE 0 END) as submittedCount,
            SUM(CASE WHEN conclusion = 'approved' THEN 1 ELSE 0 END) as approvedCount,
            SUM(CASE WHEN conclusion = 'rejected' THEN 1 ELSE 0 END) as rejectedCount
        FROM prj_acceptance WHERE deleted = 0
    </select>
    
</mapper>
