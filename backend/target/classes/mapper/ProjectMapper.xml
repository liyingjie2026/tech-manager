<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.research.project.mapper.ProjectMapper">
    
    <resultMap id="BaseResultMap" type="com.research.project.entity.Project">
        <id column="id" property="id"/>
        <result column="project_no" property="projectNo"/>
        <result column="name" property="name"/>
        <result column="project_type" property="projectType"/>
        <result column="project_category" property="projectCategory"/>
        <result column="research_field" property="researchField"/>
        <result column="demand_id" property="demandId"/>
        <result column="institution_id" property="institutionId"/>
        <result column="institution_name" property="institutionName"/>
        <result column="leader_id" property="leaderId"/>
        <result column="leader_name" property="leaderName"/>
        <result column="leader_phone" property="leaderPhone"/>
        <result column="start_date" property="startDate"/>
        <result column="end_date" property="endDate"/>
        <result column="total_budget" property="totalBudget"/>
        <result column="apply_budget" property="applyBudget"/>
        <result column="self_budget" property="selfBudget"/>
        <result column="objective" property="objective"/>
        <result column="content" property="content"/>
        <result column="expected_result" property="expectedResult"/>
        <result column="status" property="status"/>
        <result column="audit_status" property="auditStatus"/>
        <result column="audit_comment" property="auditComment"/>
        <result column="audit_time" property="auditTime"/>
        <result column="audit_by" property="auditBy"/>
        <result column="submit_time" property="submitTime"/>
        <result column="duplicate_rate" property="duplicateRate"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="create_by" property="createBy"/>
        <result column="update_by" property="updateBy"/>
        <result column="deleted" property="deleted"/>
    </resultMap>

    <!-- 项目成员结果映射 -->
    <resultMap id="MemberResultMap" type="com.research.project.entity.ProjectMember">
        <id column="id" property="id"/>
        <result column="project_id" property="projectId"/>
        <result column="user_id" property="userId"/>
        <result column="user_name" property="userName"/>
        <result column="role" property="role"/>
        <result column="institution_id" property="institutionId"/>
        <result column="institution_name" property="institutionName"/>
        <result column="work_content" property="workContent"/>
        <result column="work_months" property="workMonths"/>
        <result column="sort_order" property="sortOrder"/>
    </resultMap>

    <!-- 项目预算结果映射 -->
    <resultMap id="BudgetResultMap" type="com.research.project.entity.ProjectBudget">
        <id column="id" property="id"/>
        <result column="project_id" property="projectId"/>
        <result column="category" property="category"/>
        <result column="item_name" property="itemName"/>
        <result column="apply_amount" property="applyAmount"/>
        <result column="self_amount" property="selfAmount"/>
        <result column="description" property="description"/>
    </resultMap>

    <!-- 项目进度计划结果映射 -->
    <resultMap id="ScheduleResultMap" type="com.research.project.entity.ProjectSchedule">
        <id column="id" property="id"/>
        <result column="project_id" property="projectId"/>
        <result column="task_no" property="taskNo"/>
        <result column="task_name" property="taskName"/>
        <result column="task_type" property="taskType"/>
        <result column="description" property="description"/>
        <result column="responsible_unit" property="responsibleUnit"/>
        <result column="responsible_person" property="responsiblePerson"/>
        <result column="start_date" property="startDate"/>
        <result column="end_date" property="endDate"/>
        <result column="milestone" property="milestone"/>
        <result column="sort_order" property="sortOrder"/>
    </resultMap>

    <!-- 项目附件结果映射 -->
    <resultMap id="AttachmentResultMap" type="com.research.project.entity.ProjectAttachment">
        <id column="id" property="id"/>
        <result column="project_id" property="projectId"/>
        <result column="file_name" property="fileName"/>
        <result column="file_path" property="filePath"/>
        <result column="file_size" property="fileSize"/>
        <result column="file_type" property="fileType"/>
        <result column="attachment_type" property="attachmentType"/>
        <result column="upload_time" property="uploadTime"/>
        <result column="upload_by" property="uploadBy"/>
    </resultMap>

    <!-- ==================== 项目列表查询 ==================== -->
    
    <!-- 分页查询项目列表 - 对应Controller: list() -->
    <select id="selectPageList" resultMap="BaseResultMap">
        <![CDATA[
        SELECT p.* FROM prj_project p
        WHERE p.deleted = 0
        ]]>
        <if test="keyword != null and keyword != ''">
            AND (p.name LIKE CONCAT('%', #{keyword}, '%') 
                 OR p.project_no LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="projectType != null and projectType != ''">
            AND p.project_type = #{projectType}
        </if>
        <if test="status != null and status != ''">
            AND p.status = #{status}
        </if>
        <if test="institutionId != null">
            AND p.institution_id = #{institutionId}
        </if>
        <if test="startDate != null and startDate != ''">
            <![CDATA[
            AND p.start_date >= #{startDate}
            ]]>
        </if>
        <if test="endDate != null and endDate != ''">
            <![CDATA[
            AND p.end_date <= #{endDate}
            ]]>
        </if>
        ORDER BY p.create_time DESC
    </select>

    <!-- 获取我的项目列表 - 对应Controller: myProjects() -->
    <select id="selectMyProjects" resultMap="BaseResultMap">
        SELECT p.* FROM prj_project p
        WHERE p.deleted = 0 AND p.create_by = #{userId}
        <if test="status != null and status != ''">
            AND p.status = #{status}
        </if>
        ORDER BY p.create_time DESC
    </select>

    <!-- 根据项目编号查询 -->
    <select id="selectByProjectNo" resultMap="BaseResultMap">
        SELECT * FROM prj_project WHERE project_no = #{projectNo} AND deleted = 0
    </select>

    <!-- 根据机构ID查询 -->
    <select id="selectByInstitutionId" resultMap="BaseResultMap">
        SELECT * FROM prj_project WHERE institution_id = #{institutionId} AND deleted = 0
        ORDER BY create_time DESC
    </select>

    <!-- 根据负责人ID查询 -->
    <select id="selectByLeaderId" resultMap="BaseResultMap">
        SELECT * FROM prj_project WHERE leader_id = #{leaderId} AND deleted = 0
        ORDER BY create_time DESC
    </select>

    <!-- ==================== 项目审核操作 ==================== -->

    <!-- 更新项目状态 - 对应Controller: submit(), withdraw(), approve(), reject() -->
    <update id="updateStatus">
        UPDATE prj_project SET 
            status = #{status},
            <if test="status == 'submitted' or status == 'pending'">
            submit_time = NOW(),
            </if>
            update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- 审核项目 - 对应Controller: approve(), reject() -->
    <update id="updateAuditInfo">
        UPDATE prj_project SET 
            audit_status = #{auditStatus},
            audit_comment = #{auditComment},
            audit_time = NOW(),
            audit_by = #{auditBy},
            status = #{status},
            update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- 批量更新状态 - 对应Controller: batchApprove(), batchReject() -->
    <update id="batchUpdateStatus">
        UPDATE prj_project SET 
            status = #{status},
            audit_status = #{auditStatus},
            audit_comment = #{auditComment},
            audit_time = NOW(),
            audit_by = #{auditBy},
            update_time = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND deleted = 0
    </update>

    <!-- ==================== 项目成员管理 ==================== -->

    <!-- 获取项目成员列表 - 对应Controller: 成员Tab加载 -->
    <select id="selectMembersByProjectId" resultMap="MemberResultMap">
        SELECT * FROM prj_project_member 
        WHERE project_id = #{projectId} AND deleted = 0
        ORDER BY sort_order ASC
    </select>

    <!-- 添加项目成员 - 对应Controller: addMember() -->
    <insert id="insertMember" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO prj_project_member (
            project_id,
            user_id,
            user_name,
            role,
            institution_id,
            institution_name,
            work_content,
            work_months,
            sort_order,
            create_time
        ) VALUES (
            #{projectId},
            <choose>
                <when test="userId != null">#{userId}</when>
                <otherwise>0</otherwise>
            </choose>,
            #{userName},
            #{role},
            #{institutionId},
            #{institutionName},
            #{workContent},
            #{workMonths},
            #{sortOrder},
            NOW()
        )
    </insert>

    <!-- 更新项目成员 - 对应Controller: updateMember() -->
    <update id="updateMember">
        UPDATE prj_project_member SET
            user_id = #{userId},
            user_name = #{userName},
            role = #{role},
            institution_id = #{institutionId},
            institution_name = #{institutionName},
            work_content = #{workContent},
            work_months = #{workMonths},
            sort_order = #{sortOrder},
            update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- 删除项目成员 - 对应Controller: removeMember() -->
    <update id="deleteMember">
        UPDATE prj_project_member SET deleted = 1, update_time = NOW()
        WHERE id = #{memberId} AND project_id = #{projectId}
    </update>

    <!-- ==================== 项目预算管理 ==================== -->

    <!-- 获取项目预算 - 对应Controller: getBudget() -->
    <select id="selectBudgetByProjectId" resultMap="BudgetResultMap">
        SELECT * FROM prj_project_budget 
        WHERE project_id = #{projectId} AND deleted = 0
        ORDER BY category, id
    </select>

    <!-- 保存项目预算 - 对应Controller: saveBudget() -->
    <insert id="insertBudget" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO prj_project_budget (
            project_id, category, item_name, apply_amount, self_amount, description, create_time
        ) VALUES (
            #{projectId}, #{category}, #{itemName}, #{applyAmount}, #{selfAmount}, #{description}, NOW()
        )
    </insert>

    <!-- 删除项目预算 -->
    <delete id="deleteBudgetByProjectId">
        DELETE FROM prj_project_budget WHERE project_id = #{projectId}
    </delete>

    <!-- ==================== 项目附件管理 ==================== -->

    <!-- 获取项目附件 - 对应Controller: 附件Tab加载 -->
    <select id="selectAttachmentsByProjectId" resultMap="AttachmentResultMap">
        SELECT * FROM prj_project_attachment 
        WHERE project_id = #{projectId} AND deleted = 0
        ORDER BY upload_time DESC
    </select>

    <!-- 上传项目附件 - 对应Controller: uploadAttachment() -->
    <insert id="insertAttachment" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO prj_project_attachment (
            project_id, file_name, file_path, file_size, file_type, 
            attachment_type, upload_time, upload_by
        ) VALUES (
            #{projectId}, #{fileName}, #{filePath}, #{fileSize}, #{fileType},
            #{attachmentType}, NOW(), #{uploadBy}
        )
    </insert>

    <!-- 删除项目附件 - 对应Controller: deleteAttachment() -->
    <update id="deleteAttachment">
        UPDATE prj_project_attachment SET deleted = 1, update_time = NOW()
        WHERE id = #{attachmentId} AND project_id = #{projectId}
    </update>

    <!-- 获取附件详情 - 对应Controller: downloadAttachment() -->
    <select id="selectAttachmentById" resultMap="AttachmentResultMap">
        SELECT * FROM prj_project_attachment WHERE id = #{id} AND deleted = 0
    </select>

    <!-- ==================== 项目进度管理 ==================== -->

    <!-- 获取项目进度计划 - 对应Controller: 进度计划Tab加载 -->
    <select id="selectSchedulesByProjectId" resultMap="ScheduleResultMap">
        SELECT * FROM prj_project_schedule 
        WHERE project_id = #{projectId} AND deleted = 0
        ORDER BY sort_order ASC
    </select>

    <!-- 添加进度计划项 - 对应Controller: addScheduleItem() -->
    <insert id="insertSchedule" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO prj_project_schedule (
            project_id, task_no, task_name, task_type, description,
            responsible_unit, responsible_person, start_date, end_date,
            milestone, sort_order, create_time
        ) VALUES (
            #{projectId}, #{taskNo}, #{taskName}, #{taskType}, #{description},
            #{responsibleUnit}, #{responsiblePerson}, #{startDate}, #{endDate},
            #{milestone}, #{sortOrder}, NOW()
        )
    </insert>

    <!-- 更新进度计划项 -->
    <update id="updateSchedule">
        UPDATE prj_project_schedule SET
            task_no = #{taskNo},
            task_name = #{taskName},
            task_type = #{taskType},
            description = #{description},
            responsible_unit = #{responsibleUnit},
            responsible_person = #{responsiblePerson},
            start_date = #{startDate},
            end_date = #{endDate},
            milestone = #{milestone},
            sort_order = #{sortOrder},
            update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- 删除进度计划项 - 对应Controller: deleteScheduleItem() -->
    <update id="deleteSchedule">
        UPDATE prj_project_schedule SET deleted = 1, update_time = NOW()
        WHERE id = #{scheduleId} AND project_id = #{projectId}
    </update>

    <!-- 批量保存进度计划 - 对应Controller: saveSchedule() -->
    <delete id="deleteSchedulesByProjectId">
        DELETE FROM prj_project_schedule WHERE project_id = #{projectId}
    </delete>

    <!-- ==================== 项目绩效指标 ==================== -->

    <!-- 获取绩效指标 -->
    <select id="selectPerformanceByProjectId" resultType="com.research.project.entity.ProjectPerformance">
        SELECT * FROM prj_project_performance WHERE project_id = #{projectId} AND deleted = 0
    </select>

    <!-- 保存绩效指标 - 对应Controller: savePerformance() -->
    <insert id="insertPerformance">
        INSERT INTO prj_project_performance (
            project_id, duplicate_rate, create_time
        ) VALUES (
            #{projectId}, #{duplicateRate}, NOW()
        )
    </insert>

    <!-- 更新绩效指标 -->
    <update id="updatePerformance">
        UPDATE prj_project_performance SET
            duplicate_rate = #{duplicateRate},
            update_time = NOW()
        WHERE project_id = #{projectId} AND deleted = 0
    </update>

    <!-- ==================== 项目查重 ==================== -->

    <!-- 更新查重率 - 对应Controller: duplicateCheck() -->
    <update id="updateDuplicateRate">
        UPDATE prj_project SET 
            duplicate_rate = #{duplicateRate},
            update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- 获取查重结果 - 对应Controller: getDuplicateCheckResult() -->
    <select id="selectDuplicateResult" resultType="com.research.project.entity.DuplicateCheckResult">
        SELECT * FROM prj_duplicate_check_result 
        WHERE project_id = #{projectId} 
        ORDER BY create_time DESC LIMIT 1
    </select>

    <!-- 保存查重结果 -->
    <insert id="insertDuplicateResult">
        INSERT INTO prj_duplicate_check_result (
            project_id, duplicate_rate, similar_projects, check_time, check_by
        ) VALUES (
            #{projectId}, #{duplicateRate}, #{similarProjects}, NOW(), #{checkBy}
        )
    </insert>

    <!-- ==================== 项目统计 ==================== -->

    <!-- 获取项目统计数据 - 对应Controller: getStatistics() -->
    <select id="selectStatistics" resultType="map">
        SELECT 
            COUNT(*) as total,
            SUM(CASE WHEN status = 'draft' THEN 1 ELSE 0 END) as draftCount,
            SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) as pendingCount,
            SUM(CASE WHEN status = 'approved' THEN 1 ELSE 0 END) as approvedCount,
            SUM(CASE WHEN status = 'rejected' THEN 1 ELSE 0 END) as rejectedCount,
            SUM(CASE WHEN status = 'in_progress' THEN 1 ELSE 0 END) as inProgressCount,
            SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) as completedCount,
            SUM(total_budget) as totalBudget,
            SUM(apply_budget) as totalApplyBudget
        FROM prj_project WHERE deleted = 0
    </select>

    <!-- 按类型统计项目数量 -->
    <select id="selectCountByType" resultType="map">
        SELECT project_type as type, COUNT(*) as count
        FROM prj_project WHERE deleted = 0
        GROUP BY project_type
    </select>

    <!-- 按状态统计项目数量 -->
    <select id="selectCountByStatus" resultType="map">
        SELECT status, COUNT(*) as count
        FROM prj_project WHERE deleted = 0
        GROUP BY status
    </select>

    <!-- 按年份统计项目数量 -->
    <select id="selectCountByYear" resultType="map">
        SELECT YEAR(create_time) as year, COUNT(*) as count
        FROM prj_project WHERE deleted = 0
        GROUP BY YEAR(create_time)
        ORDER BY year DESC
        LIMIT #{years}
    </select>

    <!-- 按机构统计项目数量 -->
    <select id="selectCountByInstitution" resultType="map">
        SELECT institution_id, institution_name, COUNT(*) as count
        FROM prj_project WHERE deleted = 0
        GROUP BY institution_id, institution_name
        ORDER BY count DESC
        LIMIT #{top}
    </select>

</mapper>
